# Atomic Red Team Integration Guide

This guide explains how to use Atomic Red Team (ART) to generate realistic security logs for log-simulator templates.

## Overview

**Atomic Red Team** is a library of tests mapped to the MITRE ATT&CK framework. Each test simulates a specific adversary technique, which generates authentic logs in security tools like CrowdStrike, Sysmon, Windows Event Logs, etc.

**Integration Strategy**:
1. Execute ART tests in a controlled environment
2. Capture logs generated by security tools
3. Extract patterns and create templates
4. Use templates with log-simulator for scaled generation

## Prerequisites

### Test Environment Requirements

1. **Sandboxed System**
   - Virtual machine (VMware, VirtualBox, Hyper-V)
   - Cloud instance (AWS, Azure, GCP)
   - Isolated network segment
   - Snapshot capability for quick resets

2. **Operating Systems**
   - Windows 10/11 (for Windows-specific tests)
   - Windows Server 2016/2019/2022
   - Linux (Ubuntu, CentOS)
   - macOS (for Mac-specific tests)

3. **Security Tools Installed**
   - **CrowdStrike Falcon** - EDR logs
   - **Sysmon** - Windows event logging
   - **Windows Event Forwarding** - Native Windows logs
   - **Osquery** - Endpoint monitoring
   - **Elastic Agent** - Elastic Security
   - **Splunk Universal Forwarder** - Log collection

4. **Atomic Red Team Setup**
   ```powershell
   # Windows PowerShell (Run as Administrator)
   IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing)
   Install-AtomicRedTeam -getAtomics
   ```

   ```bash
   # Linux/macOS
   git clone https://github.com/redcanaryco/atomic-red-team.git
   cd atomic-red-team
   ```

## Step-by-Step Integration Process

### Phase 1: Environment Setup

#### 1.1 Configure Log Collection

**CrowdStrike Falcon**:
```powershell
# Ensure FDR is enabled and logs are being sent to your SIEM or S3
# Contact CrowdStrike support to enable FDR if not already active
```

**Sysmon**:
```powershell
# Download and install Sysmon
Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Sysmon.zip" -OutFile "Sysmon.zip"
Expand-Archive Sysmon.zip -DestinationPath C:\Sysmon
cd C:\Sysmon

# Use SwiftOnSecurity's config (comprehensive logging)
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml" -OutFile "sysmonconfig.xml"
.\Sysmon64.exe -accepteula -i sysmonconfig.xml
```

**Windows Event Log**:
```powershell
# Enable detailed logging
auditpol /set /category:"Detailed Tracking" /success:enable /failure:enable
auditpol /set /category:"Object Access" /success:enable /failure:enable
auditpol /set /category:"Privilege Use" /success:enable /failure:enable
```

#### 1.2 Configure Log Export

**Export to JSON**:
```powershell
# Export Windows Event Logs to JSON
wevtutil qe Security /f:JSON /rd:true /c:1000 > security_logs.json
wevtutil qe "Microsoft-Windows-Sysmon/Operational" /f:JSON /rd:true /c:1000 > sysmon_logs.json
```

**Configure SIEM Collection**:
- Set up log forwarding to Splunk/Elastic/SIEM
- Enable JSON output format
- Configure appropriate indexes/indices

### Phase 2: Execute Atomic Tests

#### 2.1 List Available Tests

```powershell
# List all atomics
Get-AtomicTest -Path C:\AtomicRedTeam\atomics

# List tests for specific technique
Get-AtomicTest -Path C:\AtomicRedTeam\atomics\T1059.001  # PowerShell execution

# Show test details
Get-AtomicTest -Path C:\AtomicRedTeam\atomics\T1059.001 -ShowDetails
```

#### 2.2 Execute Individual Tests

**Example 1: PowerShell Execution (T1059.001)**
```powershell
# Check prerequisites
Invoke-AtomicTest T1059.001 -CheckPrereqs

# Execute test
Invoke-AtomicTest T1059.001

# Cleanup
Invoke-AtomicTest T1059.001 -Cleanup
```

**Example 2: Credential Dumping (T1003.001)**
```powershell
# LSASS memory dumping
Invoke-AtomicTest T1003.001 -TestNumbers 1

# Cleanup
Invoke-AtomicTest T1003.001 -TestNumbers 1 -Cleanup
```

**Example 3: Registry Persistence (T1547.001)**
```powershell
# Registry Run Keys
Invoke-AtomicTest T1547.001

# Cleanup
Invoke-AtomicTest T1547.001 -Cleanup
```

#### 2.3 Execute Test Sequences

**Simulate Attack Chain**:
```powershell
# Initial Access -> Execution -> Persistence -> Privilege Escalation
$attack_chain = @(
    "T1566.001",  # Phishing: Spearphishing Attachment
    "T1059.001",  # PowerShell
    "T1547.001",  # Registry Run Keys
    "T1055.001"   # Process Injection
)

foreach ($technique in $attack_chain) {
    Write-Host "Executing $technique..." -ForegroundColor Yellow
    Invoke-AtomicTest $technique
    Start-Sleep -Seconds 30  # Wait for logs to generate
}
```

### Phase 3: Capture and Extract Logs

#### 3.1 Immediate Log Capture

**CrowdStrike**:
```powershell
# Logs are automatically sent to FDR
# Export from CrowdStrike console or S3 bucket
# File format: JSON (one event per line)
```

**Sysmon**:
```powershell
# Export Sysmon logs
$startTime = (Get-Date).AddMinutes(-10)
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-Sysmon/Operational'; StartTime=$startTime} |
    ConvertTo-Json | Out-File -FilePath "sysmon_atomic_logs.json"
```

**Windows Event Log**:
```powershell
# Export Security logs
$startTime = (Get-Date).AddMinutes(-10)
Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime=$startTime} |
    ConvertTo-Json | Out-File -FilePath "security_atomic_logs.json"
```

#### 3.2 Organized Capture by Technique

Create a logging script:

```powershell
# capture_atomic_logs.ps1
param(
    [Parameter(Mandatory=$true)]
    [string]$TechniqueID,

    [Parameter(Mandatory=$true)]
    [string]$OutputDir
)

$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$outputPath = "$OutputDir\$TechniqueID"
New-Item -ItemType Directory -Path $outputPath -Force | Out-Null

Write-Host "Executing $TechniqueID..." -ForegroundColor Green

# Capture baseline (before test)
$beforeTime = Get-Date

# Execute test
Invoke-AtomicTest $TechniqueID

# Wait for logs to propagate
Start-Sleep -Seconds 10

# Capture logs (after test)
$afterTime = Get-Date

# Export Sysmon
Get-WinEvent -FilterHashtable @{
    LogName='Microsoft-Windows-Sysmon/Operational';
    StartTime=$beforeTime
} | ConvertTo-Json | Out-File "$outputPath\sysmon_${timestamp}.json"

# Export Security
Get-WinEvent -FilterHashtable @{
    LogName='Security';
    StartTime=$beforeTime
} | ConvertTo-Json | Out-File "$outputPath\security_${timestamp}.json"

# Export PowerShell
Get-WinEvent -FilterHashtable @{
    LogName='Microsoft-Windows-PowerShell/Operational';
    StartTime=$beforeTime
} | ConvertTo-Json | Out-File "$outputPath\powershell_${timestamp}.json"

# Cleanup
Invoke-AtomicTest $TechniqueID -Cleanup

Write-Host "Logs captured to $outputPath" -ForegroundColor Green
```

**Usage**:
```powershell
.\capture_atomic_logs.ps1 -TechniqueID "T1059.001" -OutputDir "C:\ART_Logs"
```

### Phase 4: Process and Template Creation

#### 4.1 Analyze Captured Logs

**Identify Key Fields**:
```python
import json
from collections import Counter

# Load captured logs
with open('sysmon_T1059.001.json', 'r') as f:
    logs = [json.loads(line) for line in f]

# Identify common fields
all_fields = set()
for log in logs:
    all_fields.update(log.keys())

print("Common fields:", all_fields)

# Analyze field distributions
event_ids = Counter(log.get('EventID') for log in logs)
print("Event ID distribution:", event_ids)
```

#### 4.2 Create Template from Logs

**Extract Template Pattern**:
```python
# create_template.py
import json

def create_template_from_log(log_file, output_template):
    """Extract template pattern from captured log."""

    with open(log_file, 'r') as f:
        logs = [json.loads(line) for line in f]

    if not logs:
        return

    # Use first log as template base
    template = logs[0].copy()

    # Identify variable fields
    variable_fields = {
        'timestamp': '{{timestamp}}',
        'EventRecordID': '{{record_id}}',
        'ProcessId': '{{process_id}}',
        'ThreadId': '{{thread_id}}',
        'UtcTime': '{{utc_time}}',
        # Add more as identified
    }

    # Replace variable fields
    for field, placeholder in variable_fields.items():
        if field in template:
            template[field] = placeholder

    # Save template
    with open(output_template, 'w') as f:
        json.dump(template, f, indent=2)

    print(f"Template created: {output_template}")

# Usage
create_template_from_log(
    'sysmon_T1059.001.json',
    '../src/log_simulator/templates/security/sysmon_powershell_execution.json'
)
```

#### 4.3 Organize Templates by MITRE ATT&CK

**Directory Structure**:
```
templates/
├── security/
│   ├── crowdstrike/
│   │   ├── T1059.001_powershell_execution.json
│   │   ├── T1003.001_credential_dumping.json
│   │   └── T1547.001_registry_persistence.json
│   ├── sysmon/
│   │   ├── T1059.001_process_creation.json
│   │   ├── T1003.001_process_access.json
│   │   └── T1055.001_process_injection.json
│   └── windows_event/
│       ├── T1078_account_logon.json
│       └── T1136_account_creation.json
└── metadata/
    └── technique_mapping.json
```

**Metadata File** (`technique_mapping.json`):
```json
{
  "T1059.001": {
    "name": "PowerShell",
    "tactic": "Execution",
    "templates": {
      "crowdstrike": "crowdstrike/T1059.001_powershell_execution.json",
      "sysmon": "sysmon/T1059.001_process_creation.json",
      "windows_event": null
    },
    "description": "Adversaries may abuse PowerShell commands",
    "severity": "medium"
  },
  "T1003.001": {
    "name": "LSASS Memory",
    "tactic": "Credential Access",
    "templates": {
      "crowdstrike": "crowdstrike/T1003.001_credential_dumping.json",
      "sysmon": "sysmon/T1003.001_process_access.json"
    },
    "severity": "high"
  }
}
```

### Phase 5: Integration with log-simulator

#### 5.1 Use Templates in Generation

Once templates are created, use them with the template-based generator:

```python
from log_simulator.generators.template_generator import TemplateBasedGenerator

# Initialize with template directory
generator = TemplateBasedGenerator('templates/security/crowdstrike')

# Generate logs using specific technique template
logs = generator.generate_from_template(
    template_file='T1059.001_powershell_execution.json',
    count=100,
    time_spread_seconds=3600
)

# Generate attack scenario (multiple techniques)
attack_logs = generator.generate_attack_scenario(
    techniques=['T1059.001', 'T1003.001', 'T1547.001'],
    count_per_technique=10
)
```

#### 5.2 Validate Generated Logs

Compare generated logs against original ART captures:

```python
# validate_logs.py
def validate_generated_log(generated, original_template):
    """Validate generated log matches template structure."""

    # Check all required fields present
    template_fields = set(original_template.keys())
    generated_fields = set(generated.keys())

    missing = template_fields - generated_fields
    if missing:
        print(f"Missing fields: {missing}")
        return False

    # Check field types match
    for field in template_fields:
        if type(generated[field]) != type(original_template[field]):
            if not (field in variable_fields):  # Allow variables
                print(f"Type mismatch in {field}")
                return False

    return True
```

## Recommended Test Matrix

Execute these tests to build comprehensive template library:

### Initial Access
- T1566.001 - Spearphishing Attachment
- T1078 - Valid Accounts
- T1190 - Exploit Public-Facing Application

### Execution
- T1059.001 - PowerShell
- T1059.003 - Windows Command Shell
- T1059.005 - Visual Basic
- T1204.002 - Malicious File

### Persistence
- T1547.001 - Registry Run Keys
- T1053.005 - Scheduled Task
- T1136.001 - Local Account Creation

### Privilege Escalation
- T1055.001 - Process Injection
- T1134 - Access Token Manipulation

### Defense Evasion
- T1070.001 - Clear Windows Event Logs
- T1112 - Modify Registry
- T1027 - Obfuscated Files

### Credential Access
- T1003.001 - LSASS Memory
- T1003.002 - Security Account Manager
- T1110.001 - Password Guessing

### Discovery
- T1087.001 - Local Account Discovery
- T1082 - System Information Discovery
- T1083 - File and Directory Discovery

### Lateral Movement
- T1021.001 - Remote Desktop Protocol
- T1021.002 - SMB/Windows Admin Shares
- T1570 - Lateral Tool Transfer

### Collection
- T1005 - Data from Local System
- T1114.001 - Local Email Collection

### Command and Control
- T1071.001 - Web Protocols
- T1095 - Non-Application Layer Protocol

### Exfiltration
- T1041 - Exfiltration Over C2 Channel
- T1048 - Exfiltration Over Alternative Protocol

## Best Practices

### Safety
1. **Always use isolated environments** - Never run on production systems
2. **Take snapshots** before running tests
3. **Monitor resource usage** - Some tests are resource-intensive
4. **Review test code** before execution
5. **Use least privilege** where possible
6. **Have cleanup procedures** ready

### Efficiency
1. **Batch similar tests** together
2. **Automate log collection** with scripts
3. **Tag logs with technique IDs** for easy organization
4. **Document test parameters** and environment state
5. **Version control templates** as you refine them

### Quality
1. **Validate logs** against real attacks when possible
2. **Test across different OS versions** (Windows 10, 11, Server 2019, 2022)
3. **Capture from multiple security tools** for same test
4. **Review with security team** for realism
5. **Update templates** when ART tests change

## Troubleshooting

### Common Issues

**Issue**: No logs generated
- **Solution**: Check security tool is running and logging enabled
- **Solution**: Verify log collection configuration
- **Solution**: Increase wait time after test execution

**Issue**: Test fails to execute
- **Solution**: Check prerequisites with `-CheckPrereqs`
- **Solution**: Run PowerShell as Administrator
- **Solution**: Check ART is updated: `Update-AtomicRedTeam`

**Issue**: Logs missing expected fields
- **Solution**: Update security tool configuration for verbose logging
- **Solution**: Check tool version compatibility
- **Solution**: Review tool documentation for log schema changes

## Additional Resources

- **Atomic Red Team Docs**: https://github.com/redcanaryco/atomic-red-team/wiki
- **MITRE ATT&CK**: https://attack.mitre.org/
- **Sysmon Config**: https://github.com/SwiftOnSecurity/sysmon-config
- **Sigma Rules**: https://github.com/SigmaHQ/sigma (for validation)
- **Detection Lab**: https://github.com/clong/DetectionLab (pre-built environment)

## Example Workflow

Complete workflow for one technique:

```powershell
# 1. Setup
$technique = "T1059.001"
$output = "C:\ART_Logs\$technique"
New-Item -ItemType Directory -Path $output -Force

# 2. Pre-test snapshot
Get-Process | Export-Csv "$output\baseline_processes.csv"

# 3. Execute
Invoke-AtomicTest $technique

# 4. Capture logs (wait 10 seconds)
Start-Sleep -Seconds 10
Get-WinEvent -FilterHashtable @{
    LogName='Microsoft-Windows-Sysmon/Operational';
    StartTime=(Get-Date).AddMinutes(-5)
} | ConvertTo-Json | Out-File "$output\sysmon.json"

# 5. Cleanup
Invoke-AtomicTest $technique -Cleanup

# 6. Create template
python create_template.py "$output\sysmon.json" "../templates/security/sysmon/$technique.json"
```

---

**Last Updated**: 2025-11-16
**Version**: 1.0
